<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KenPom Visualization Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- DataTables CSS and JS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>KenPom Basketball Analytics</h1>
            <p class="subtitle">Updated daily with the latest statistics</p>
            <p class="last-updated">Last updated: <span id="last-updated"></span></p>
        </header>

        <main>
            <section class="section">
                <h2>Weekly Performance Tracking</h2>
                <div id="weekly-performance-container">
                    <div id="loading-message" class="loading-message">Loading current week's performance data...</div>
                    <div id="error-message" class="error-message" style="display: none;"></div>
                    <table id="performance-table" class="display" style="width:100%; display: none;">
                        <thead>
                            <tr>
                                <th>Capture Time</th>
                                <th>Game</th>
                                <th>Team</th>
                                <th>Game Time</th>
                                <th>Opening Odds Time</th>
                                <th>Edge Type</th>
                                <th>Edge Value</th>
                                <th>Predicted Outcome</th>
                                <th>Probability</th>
                                <th>Opening Line</th>
                                <th>Current Line</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="section">
                <h2>Top 100 Teams Overview</h2>
                <div class="plot-container">
                    <div class="plot-item">
                        <img src="plots/kenpom_top100_eff.png" alt="Top 100 Teams Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                </div>
            </section>
        <main>
            <section class="section">
                <h2>March Madness Winner Watch List</h2>
                <div class="plot-container">
                    <div class="plot-item">
                        <img src="plots/mm_winner_plot.png" alt="March Madness Winner Watch List Plot" onerror="handleImageError(this)">
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>Daily Matchups</h2>
                <div class="plot-container">
                    <div class="plot-item">
                        <img src="plots/daily_matchups.png" alt="Daily Matchups Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                </div>
            </section>
            <section class="section">
                <h2>AP Top 25 Teams</h2>
                <div class="plot-container">
                    <div class="plot-item">
                        <img src="plots/kenpom_ap25_eff.png" alt="AP Top 25 Teams Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>Power 5 Conferences</h2>
                <div class="conference-grid power5-grid">
                    <div class="plot-item power5-item">
                        <h3 class="plot-title">ACC</h3>
                        <img src="plots/conferences/kenpom_acc_eff.png" alt="ACC Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item power5-item">
                        <h3 class="plot-title">Big 10</h3>
                        <img src="plots/conferences/kenpom_b10_eff.png" alt="Big 10 Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item power5-item">
                        <h3 class="plot-title">Big 12</h3>
                        <img src="plots/conferences/kenpom_b12_eff.png" alt="Big 12 Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item power5-item">
                        <h3 class="plot-title">Big East</h3>
                        <img src="plots/conferences/kenpom_be_eff.png" alt="Big East Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item power5-item">
                        <h3 class="plot-title">SEC</h3>
                        <img src="plots/conferences/kenpom_sec_eff.png" alt="SEC Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>Other Conferences</h2>
                <div class="conference-grid">
                    <div class="plot-item">
                        <h3 class="plot-title">America East</h3>
                        <img src="plots/conferences/kenpom_ae_eff.png" alt="America East Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">American Athletic</h3>
                        <img src="plots/conferences/kenpom_amer_eff.png" alt="American Athletic Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Atlantic 10</h3>
                        <img src="plots/conferences/kenpom_a10_eff.png" alt="Atlantic 10 Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Atlantic Sun</h3>
                        <img src="plots/conferences/kenpom_asun_eff.png" alt="Atlantic Sun Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Big Sky</h3>
                        <img src="plots/conferences/kenpom_bsky_eff.png" alt="Big Sky Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Big South</h3>
                        <img src="plots/conferences/kenpom_bsth_eff.png" alt="Big South Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Big West</h3>
                        <img src="plots/conferences/kenpom_bw_eff.png" alt="Big West Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Colonial Athletic</h3>
                        <img src="plots/conferences/kenpom_caa_eff.png" alt="Colonial Athletic Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Conference USA</h3>
                        <img src="plots/conferences/kenpom_cusa_eff.png" alt="Conference USA Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Horizon League</h3>
                        <img src="plots/conferences/kenpom_horz_eff.png" alt="Horizon League Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Ivy League</h3>
                        <img src="plots/conferences/kenpom_ivy_eff.png" alt="Ivy League Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">MAAC</h3>
                        <img src="plots/conferences/kenpom_maac_eff.png" alt="MAAC Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">MAC</h3>
                        <img src="plots/conferences/kenpom_mac_eff.png" alt="MAC Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">MEAC</h3>
                        <img src="plots/conferences/kenpom_meac_eff.png" alt="MEAC Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Missouri Valley</h3>
                        <img src="plots/conferences/kenpom_mvc_eff.png" alt="Missouri Valley Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Mountain West</h3>
                        <img src="plots/conferences/kenpom_mwc_eff.png" alt="Mountain West Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Northeast</h3>
                        <img src="plots/conferences/kenpom_nec_eff.png" alt="Northeast Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Ohio Valley</h3>
                        <img src="plots/conferences/kenpom_ovc_eff.png" alt="Ohio Valley Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Patriot League</h3>
                        <img src="plots/conferences/kenpom_pl_eff.png" alt="Patriot League Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Southern</h3>
                        <img src="plots/conferences/kenpom_sc_eff.png" alt="Southern Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Southland</h3>
                        <img src="plots/conferences/kenpom_slnd_eff.png" alt="Southland Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Sun Belt</h3>
                        <img src="plots/conferences/kenpom_sb_eff.png" alt="Sun Belt Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">Summit League</h3>
                        <img src="plots/conferences/kenpom_sum_eff.png" alt="Summit League Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">SWAC</h3>
                        <img src="plots/conferences/kenpom_swac_eff.png" alt="SWAC Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">WAC</h3>
                        <img src="plots/conferences/kenpom_wac_eff.png" alt="WAC Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                    <div class="plot-item">
                        <h3 class="plot-title">West Coast</h3>
                        <img src="plots/conferences/kenpom_wcc_eff.png" alt="West Coast Conference Efficiency Plot" onerror="handleImageError(this)">
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>Data source: <a href="https://kenpom.com" target="_blank">KenPom.com</a></p>
            <p>This site is updated daily with the latest college basketball analytics</p>
        </footer>
    </div>

    <script>
        // Function to calculate ISO week number
        function getISOWeek(date) {
            const target = new Date(date.valueOf());
            const dayNr = (date.getDay() + 6) % 7;
            target.setDate(target.getDate() - dayNr + 3);
            const firstThursday = target.valueOf();
            target.setMonth(0, 1);
            if (target.getDay() !== 4) {
                target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - target) / 604800000);
        }

        // Function to get ISO year for the week
        function getISOYear(date) {
            const target = new Date(date.valueOf());
            const dayNr = (date.getDay() + 6) % 7;
            target.setDate(target.getDate() - dayNr + 3);
            return target.getFullYear();
        }

        // Load weekly performance data
        function loadWeeklyPerformance() {
            const now = new Date();
            const year = getISOYear(now);
            const week = getISOWeek(now);
            
            const csvUrl = `https://raw.githubusercontent.com/trashduty/kp_test/main/performance_tracking/weekly_performance_${year}_W${week}.csv`;
            
            console.log(`Loading performance data for ${year} Week ${week}`);
            console.log(`CSV URL: ${csvUrl}`);
            
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        // Hide loading message
                        document.getElementById('loading-message').style.display = 'none';
                        
                        // Show and populate table
                        const table = document.getElementById('performance-table');
                        table.style.display = 'table';
                        
                        // Initialize DataTable
                        $('#performance-table').DataTable({
                            data: results.data,
                            columns: [
                                { data: 'Capture Time' },
                                { data: 'Game' },
                                { data: 'Team' },
                                { data: 'Game Time' },
                                { data: 'Opening Odds Time' },
                                { data: 'Edge Type' },
                                { 
                                    data: 'Edge Value',
                                    render: function(data) {
                                        return parseFloat(data).toFixed(4);
                                    }
                                },
                                { 
                                    data: 'Predicted Outcome',
                                    render: function(data) {
                                        return parseFloat(data).toFixed(1);
                                    }
                                },
                                { 
                                    data: 'Probability',
                                    render: function(data) {
                                        return (parseFloat(data) * 100).toFixed(2) + '%';
                                    }
                                },
                                { 
                                    data: 'Opening Line',
                                    render: function(data) {
                                        return parseFloat(data).toFixed(1);
                                    }
                                },
                                { 
                                    data: 'Current Line',
                                    render: function(data) {
                                        return parseFloat(data).toFixed(1);
                                    }
                                }
                            ],
                            pageLength: 25,
                            responsive: true,
                            order: [[0, 'desc']], // Sort by Capture Time descending
                            language: {
                                search: "Search performance data:",
                                lengthMenu: "Show _MENU_ entries per page",
                                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                                infoEmpty: "No entries available",
                                infoFiltered: "(filtered from _MAX_ total entries)"
                            }
                        });
                    } else {
                        showError(`No data found for ${year} Week ${week}.`);
                    }
                },
                error: function(error) {
                    console.error('Error loading CSV:', error);
                    showError(`Unable to load performance data for ${year} Week ${week}. The data file may not exist yet.`);
                }
            });
        }

        // Show error message
        function showError(message) {
            document.getElementById('loading-message').style.display = 'none';
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Update the last-updated date
        document.getElementById('last-updated').textContent = new Date().toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });

        // Error handling for images
        function handleImageError(img) {
            console.error(`Failed to load image: ${img.src}`);
            img.style.display = 'none';
            
            // Remove loading state
            const plotItem = img.closest('.plot-item');
            if (plotItem) {
                plotItem.classList.remove('loading');
            }
            
            // Check if error message already exists
            const existingError = img.parentNode.querySelector('.error-message');
            if (!existingError) {
                const error = document.createElement('div');
                error.className = 'error-message';
                error.textContent = 'Plot currently unavailable';
                img.parentNode.appendChild(error);
            }
        }

        // Add loading state for images
        document.addEventListener('DOMContentLoaded', function() {
            // Load weekly performance data
            loadWeeklyPerformance();
            
            // Handle image loading
            const images = document.querySelectorAll('.plot-item img');
            images.forEach(img => {
                const plotItem = img.closest('.plot-item');
                
                // Add loading class
                if (plotItem && !img.complete) {
                    plotItem.classList.add('loading');
                }
                
                img.addEventListener('load', function() {
                    this.classList.add('loaded');
                    // Remove loading class
                    if (plotItem) {
                        plotItem.classList.remove('loading');
                    }
                });
            });
        });
    </script>
</body>
</html>
