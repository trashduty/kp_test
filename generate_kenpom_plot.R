# Force R to use the correct library path set by GitHub Actions
.libPaths(c(Sys.getenv("R_LIBS_USER"), .libPaths()))

# Load libraries
library(tidyverse)

cat("üîé .libPaths():\n")
print(.libPaths())

cat("üîç Checking if 'ggimage' is installed...\n")
if (!requireNamespace("ggimage", quietly = TRUE)) {
  stop("‚ùå ggimage is NOT installed in the visible lib paths.")
} else {
  cat("‚úÖ ggimage is installed. Proceeding to load.\n")
  library(ggimage)
}

# Load and clean data
eff_stats <- read_csv("kenpom_stats.csv", show_col_types = FALSE) |>
  rename(
    ORtg = `ORtg...6`,
    ORtg_rank = `ORtg...7`,
    DRtg = `DRtg...8`,
    DRtg_rank = `DRtg...9`,
    AdjT = `AdjT...10`,
    AdjT_rank = `AdjT...11`,
    Luck = `Luck...12`,
    Luck_rank = `Luck...13`
  )

ncaa_teams <- read_csv("ncaa_teams_colors_logos_CBB.csv", show_col_types = FALSE) |>
  distinct(current_team, .keep_all = TRUE)

# Select teams
eff_stats_selected <- eff_stats |> 
  slice(1:100) |>  
  left_join(ncaa_teams, by = c("Team" = "current_team")) |> 
  mutate(NetEfficiency = ORtg - DRtg)

# Means for quadrant lines
mean_ORtg <- mean(eff_stats_selected$ORtg, na.rm = TRUE)
mean_DRtg <- mean(eff_stats_selected$DRtg, na.rm = TRUE)

# Plot
p <- eff_stats_selected |> 
  ggplot(aes(x = ORtg, y = DRtg)) +
  annotate("rect", xmin = mean_ORtg, xmax = Inf, ymin = -Inf, ymax = mean_DRtg, alpha = 0.1, fill = "green") +
  annotate("rect", xmin = -Inf, xmax = mean_ORtg, ymin = mean_DRtg, ymax = Inf, alpha = 0.1, fill = "red") +
  geom_hline(yintercept = mean_DRtg, linetype = "dashed") +
  geom_vline(xintercept = mean_ORtg, linetype = "dashed") +
  geom_image(aes(image = logo), size = 0.05, asp = 16/9) +
  theme_bw() +
  labs(
    x = "Adjusted Offensive Efficiency",
    y = "Adjusted Defensive Efficiency",
    title = "Men's CBB Landscape | Top 100 Teams",
    subtitle = "Using data from kenpom.com"
  ) +
  theme(
    plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    axis.title = element_text(size = 25),
    plot.caption = element_text(size = 25)
  ) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
  scale_y_reverse(breaks = scales::pretty_breaks(n = 6))

# Save
ggsave("kenpom_top100_eff.png", plot = p, width = 14, height = 10, dpi = "retina")
